<!DOCTYPE html>
<html>
<head>
    <title>Sound Controller</title>
</head>
<body data-sound-to-play="none"> <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // 1. 오디오 컨텍스트를 활성화하는 함수
        // 이 함수는 이제 Python의 버튼 클릭과 직접 연결되지 않고, 첫 상호작용 시 호출됩니다.
        async function initAudio() {
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
                console.log("AudioContext has been resumed.");
                // 활성화 성공 신호를 Python으로 전송
                window.parent.Streamlit.setComponentValue({ activated: true });
            }
        }
        
        // 2. 실제 소리를 재생하는 함수
        function playSound(type) {
            if (audioContext.state !== 'running') {
                console.warn("AudioContext is not running. Activating now...");
                // 소리 재생 전, 혹시 활성화되지 않았다면 다시 시도
                initAudio().then(() => {
                    if (audioContext.state === 'running') playSound(type);
                });
                return;
            }

            if (type === 'fire') {
                const masterGain = audioContext.createGain();
                masterGain.gain.setValueAtTime(0.3, audioContext.currentTime);
                masterGain.connect(audioContext.destination);
                let highTone = 800, lowTone = 450, duration = 0.15, startTime = audioContext.currentTime;
                for (let i = 0; i < 4; i++) {
                    const osc = audioContext.createOscillator();
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(i % 2 === 0 ? highTone : lowTone, startTime + i * duration);
                    osc.connect(masterGain);
                    osc.start(startTime + i * duration);
                    osc.stop(startTime + (i + 1) * duration);
                }
            } else if (type === 'safety') {
                function createBeep(startTime) {
                    const osc = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, startTime);
                    gainNode.gain.setValueAtTime(0.4, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + 0.2);
                    osc.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    osc.start(startTime);
                    osc.stop(startTime + 0.2);
                }
                createBeep(audioContext.currentTime);
                createBeep(audioContext.currentTime + 0.25);
            }
        }

        // 3. 컴포넌트가 로드될 때 실행되는 로직
        window.addEventListener('load', () => {
            const body = document.body;
            // Python으로부터 '재생할 소리' 값을 받습니다.
            const soundToPlay = body.getAttribute('data-sound-to-play');

            // 'activate' 명령이 오면 오디오를 활성화 시도
            if (soundToPlay === 'activate') {
                initAudio();
            } 
            // 'fire' 또는 'safety' 명령이 오면 해당 소리를 재생
            else if (soundToPlay && soundToPlay !== 'none') {
                playSound(soundToPlay);
            }
        });
    </script>
</body>
</html>
